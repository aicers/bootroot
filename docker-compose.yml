services:
  openbao:
    image: openbao/openbao:latest
    container_name: bootroot-openbao
    restart: always
    ports:
      - "8200:8200"
    expose:
      - "9101"
    volumes:
      - openbao-data:/openbao/file
      - ./openbao:/openbao/config:ro
    command: ["server", "-config=/openbao/config/openbao.hcl"]

  # PostgreSQL for step-ca. The port is exposed to the host so that
  # `bootroot rotate db` (which runs on the host) can connect directly.
  # Set POSTGRES_HOST_PORT if the default 5432 conflicts with a local instance.
  postgres:
    image: postgres:16
    container_name: bootroot-postgres
    restart: always
    environment:
      - POSTGRES_USER=step
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-step-pass}
      - POSTGRES_DB=stepca
    ports:
      - "127.0.0.1:${POSTGRES_HOST_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data

  step-ca:
    build:
      context: .
      dockerfile: docker/step-ca/Dockerfile
      args:
        - STEP_CA_VERSION=v0.29.0
    image: bootroot-step-ca:0.29.0
    container_name: bootroot-ca
    restart: always
    depends_on:
      - postgres
    ports:
      - "9000:9000"
    expose:
      - "9102"
    environment:
      - STEPUSER=step
    volumes:
      - ./secrets:/home/step
    command:
      [
        "/usr/local/bin/step-ca",
        "/home/step/config/ca.json",
        "--password-file",
        "/home/step/password.txt",
      ]

  bootroot-http01:
    build:
      context: .
      dockerfile: docker/http01-responder/Dockerfile
    image: bootroot-http01-responder:latest
    container_name: bootroot-http01
    restart: always
    ports:
      - "8080:8080"
    volumes:
      - ./responder.toml.compose:/app/responder.toml:ro
    command:
      - --config=/app/responder.toml
    networks:
      default:

  bootroot-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bootroot-agent
    restart: always
    depends_on:
      - step-ca
    volumes:
      - ./certs:/app/certs
      - ./secrets/certs/root_ca.crt:/app/root_ca.crt
      - ./secrets:/app/secrets:ro
      - ./agent.toml.compose:/app/agent.toml:ro
    entrypoint:
      - /bin/sh
      - -lc
    command:
      - |
        cp /app/agent.toml /app/certs/agent.runtime.toml
        exec /app/bootroot-agent \
          --oneshot \
          --ca-url=https://bootroot-ca:9000/acme/acme/directory \
          --config=/app/certs/agent.runtime.toml
    environment:
      - RUST_LOG=debug

  prometheus:
    image: prom/prometheus:latest
    container_name: bootroot-prometheus
    restart: always
    profiles:
      - lan
      - public
    depends_on:
      - step-ca
      - openbao
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus

  grafana:
    image: grafana/grafana:latest
    container_name: bootroot-grafana
    restart: always
    profiles:
      - lan
    depends_on:
      - prometheus
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
    volumes:
      - ./monitoring/grafana:/etc/grafana/provisioning:ro
      - ./monitoring/dashboards:/var/lib/grafana/dashboards:ro
      - grafana-data:/var/lib/grafana
    ports:
      - "${GRAFANA_LAN_BIND_ADDR:-127.0.0.1}:3000:3000"

  grafana-public:
    image: grafana/grafana:latest
    container_name: bootroot-grafana-public
    restart: always
    profiles:
      - public
    depends_on:
      - prometheus
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
    volumes:
      - ./monitoring/grafana:/etc/grafana/provisioning:ro
      - ./monitoring/dashboards:/var/lib/grafana/dashboards:ro
      - grafana-data:/var/lib/grafana
    ports:
      - "0.0.0.0:3000:3000"

volumes:
  openbao-data:
  postgres-data:
  prometheus-data:
  grafana-data:
