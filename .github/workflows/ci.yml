name: CI

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - main

env:
  CARGO_TERM_COLOR: always

jobs:
  check:
    name: Quality Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2

      - name: Check Rust Formatting
        run: cargo fmt -- --check --config group_imports=StdExternalCrate

      - name: Check Rust Lints (Clippy)
        run: cargo clippy --all-targets -- -D warnings

      - name: Setup Biome
        uses: biomejs/setup-biome@v2
        with:
          version: latest

      - name: Run Biome (Config/JSON Check)
        run: biome ci --error-on-warnings .

      - name: Run Markdown Lint
        uses: DavidAnson/markdownlint-cli2-action@v22
        with:
          globs: "**/*.md"

      - name: Install cargo-audit
        run: cargo install cargo-audit || true

      - name: Run Security Audit
        run: cargo audit

  test:
    name: Test Suite
    needs: check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2

      # --- Unit Testing ---
      - name: Run Unit Tests
        run: cargo test

      # --- E2E Integration Testing (Docker) ---
      - name: Initialize Test CA
        run: |
          mkdir -p secrets
          echo "password" > secrets/password.txt
          # Initialize step-ca configuration
          docker run --user root --rm -v $(pwd)/secrets:/home/step smallstep/step-ca \
            step ca init \
            --name "Bootroot CI CA" \
            --provisioner "admin" \
            --dns "localhost,bootroot-ca" \
            --address ":9000" \
            --password-file /home/step/password.txt \
            --provisioner-password-file /home/step/password.txt \
            --acme

      - name: Fix Permissions (for Docker mount)
        run: |
          mkdir -p secrets certs
          sudo chmod -R 777 secrets certs

      - name: Start Services (Docker Compose)
        run: docker compose up --build -d

      - name: Wait for services
        run: sleep 10

      - name: Verify CA Health
        run: |
          for i in {1..10}; do
            if curl -k --fail https://localhost:9000/health; then
              exit 0
            fi
            echo "Waiting for CA health..."
            sleep 3
          done
          docker logs bootroot-ca
          exit 1

      - name: Verify Agent Success (E2E)
        run: |
          for i in {1..6}; do
            if docker logs bootroot-agent 2>&1 | grep -q "Successfully issued certificate"; then
              echo "PASS: Certificate issued successfully"
              exit 0
            fi
            echo "Waiting for certificate issuance..."
            sleep 5
          done

          echo "FAIL: Certificate issue message not found"
          echo "=== Agent Logs ==="
          docker logs bootroot-agent
          exit 1

      - name: Cleanup
        if: always()
        run: docker compose down
