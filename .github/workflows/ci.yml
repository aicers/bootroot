name: CI

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - main

env:
  CARGO_TERM_COLOR: always

jobs:
  check:
    name: Quality Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2

      - name: Check Rust Formatting
        run: cargo fmt -- --check --config group_imports=StdExternalCrate

      - name: Check Rust Lints (Clippy)
        run: cargo clippy --all-targets -- -D warnings

      - name: Setup Biome
        uses: biomejs/setup-biome@v2
        with:
          version: latest

      - name: Run Biome (Config/JSON Check)
        run: biome ci --error-on-warnings .

      - name: Run Markdown Lint
        uses: DavidAnson/markdownlint-cli2-action@v22
        with:
          globs: "**/*.md"

      - name: Set up MkDocs
        run: python3 -m pip install --upgrade pip mkdocs-material mkdocs-static-i18n

      - name: Build Docs
        run: mkdocs build --strict

      - name: Install cargo-audit
        run: cargo install cargo-audit || true

      - name: Run Security Audit
        run: cargo audit

  test:
    name: Test Suite
    needs: check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2

      # --- Unit Testing ---
      - name: Run Unit Tests
        run: cargo test

      # --- E2E Integration Testing (Docker) ---
      - name: Set secrets directory
        run: echo "BOOTROOT_SECRETS_DIR=$GITHUB_WORKSPACE/secrets" >> "$GITHUB_ENV"

      - name: Initialize Test CA
        run: |
          mkdir -p "$BOOTROOT_SECRETS_DIR"
          echo "password" > "$BOOTROOT_SECRETS_DIR/password.txt"
          # Initialize step-ca configuration
          docker run --user root --rm -v "$BOOTROOT_SECRETS_DIR:/home/step" smallstep/step-ca \
            step ca init \
            --name "Bootroot CI CA" \
            --provisioner "admin" \
            --dns "localhost,bootroot-ca" \
            --address ":9000" \
            --password-file /home/step/password.txt \
            --provisioner-password-file /home/step/password.txt \
            --acme

      - name: Fix Permissions (for Docker mount)
        run: |
          mkdir -p "$BOOTROOT_SECRETS_DIR" certs
          sudo chown -R "$USER":"$USER" "$BOOTROOT_SECRETS_DIR"
          sudo chmod -R 700 "$BOOTROOT_SECRETS_DIR"
          sudo chmod -R 755 certs
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start Services (Docker Compose)
        run: docker compose up -d

      - name: Wait for services
        run: sleep 10

      - name: CLI Infra Up (Smoke)
        run: |
          docker buildx bake -f docker-compose.yml \
            --set "*.cache-from=type=gha" \
            --set "*.cache-to=type=gha,mode=max" \
            --set "*.output=type=docker"
          cargo run --bin bootroot -- infra up

      - name: CLI Init (Smoke)
        run: |
          BOOTROOT_LANG=en printf "y\ny\ny\nn\n" | cargo run --bin bootroot -- init \
            --auto-generate \
            --show-secrets \
            --http-hmac "dev-hmac" \
            --db-dsn "postgresql://step:step@127.0.0.1:5432/step" \
            --secrets-dir "$BOOTROOT_SECRETS_DIR" \
            --responder-url "http://localhost:8080" | tee cli-init.log

          ROOT_TOKEN="$(awk -F': ' '/root token:/ {print $2; exit}' cli-init.log)"
          if [ -z "${ROOT_TOKEN:-}" ]; then
            echo "Failed to read root token from init output"
            exit 1
          fi
          echo "OPENBAO_ROOT_TOKEN=${ROOT_TOKEN}" >> "$GITHUB_ENV"

      - name: CLI App Add + Verify (Smoke)
        run: |
          mkdir -p tmp certs
          cat > tmp/agent.toml <<'EOF'
          email = "admin@example.com"
          server = "https://localhost:9000/acme/acme/directory"
          domain = "trusted.domain"

          [acme]
          directory_fetch_attempts = 10
          directory_fetch_base_delay_secs = 1
          directory_fetch_max_delay_secs = 10
          poll_attempts = 15
          poll_interval_secs = 2
          http_responder_url = "http://localhost:8080"
          http_responder_hmac = "dev-hmac"
          http_responder_timeout_secs = 5
          http_responder_token_ttl_secs = 300

          [[profiles]]
          service_name = "edge-proxy"
          instance_id = "001"
          hostname = "edge-node-01"

          [profiles.paths]
          cert = "certs/edge-proxy.crt"
          key = "certs/edge-proxy.key"

          [profiles.daemon]
          check_interval = "1h"
          renew_before = "720h"
          check_jitter = "0s"

          [[profiles]]
          service_name = "web-app"
          instance_id = "001"
          hostname = "web-01"

          [profiles.paths]
          cert = "certs/web-app.crt"
          key = "certs/web-app.key"

          [profiles.daemon]
          check_interval = "1h"
          renew_before = "720h"
          check_jitter = "0s"
          EOF

          cargo run --bin bootroot -- app add \
            --service-name edge-proxy \
            --deploy-type daemon \
            --hostname edge-node-01 \
            --domain trusted.domain \
            --agent-config "$(pwd)/tmp/agent.toml" \
            --cert-path "$(pwd)/certs/edge-proxy.crt" \
            --key-path "$(pwd)/certs/edge-proxy.key" \
            --instance-id 001 \
            --root-token "$OPENBAO_ROOT_TOKEN"

          cargo run --bin bootroot -- app add \
            --service-name web-app \
            --deploy-type docker \
            --hostname web-01 \
            --domain trusted.domain \
            --agent-config "$(pwd)/tmp/agent.toml" \
            --cert-path "$(pwd)/certs/web-app.crt" \
            --key-path "$(pwd)/certs/web-app.key" \
            --instance-id 001 \
            --container-name web-app \
            --root-token "$OPENBAO_ROOT_TOKEN"

          RESPONDER_IP="$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' bootroot-http01)"
          if [ -z "${RESPONDER_IP:-}" ]; then
            echo "Failed to read responder container IP"
            exit 1
          fi
          docker exec bootroot-ca sh -c "printf '%s %s\n' '$RESPONDER_IP' '001.edge-proxy.edge-node-01.trusted.domain' >> /etc/hosts"
          docker exec bootroot-ca sh -c "printf '%s %s\n' '$RESPONDER_IP' '001.web-app.web-01.trusted.domain' >> /etc/hosts"

          cargo build --bin bootroot-agent
          export PATH="$(pwd)/target/debug:$PATH"

          cargo run --bin bootroot -- verify \
            --service-name edge-proxy \
            --agent-config "$(pwd)/tmp/agent.toml"

          cargo run --bin bootroot -- verify \
            --service-name web-app \
            --agent-config "$(pwd)/tmp/agent.toml"

      - name: Verify CA Health
        run: |
          for i in {1..10}; do
            if curl -k --fail https://localhost:9000/health; then
              exit 0
            fi
            echo "Waiting for CA health..."
            sleep 3
          done
          docker logs bootroot-ca
          exit 1

      - name: Verify Agent Success (E2E)
        run: |
          for i in {1..6}; do
            if docker logs bootroot-agent 2>&1 | grep -q "Successfully issued certificate"; then
              echo "PASS: Certificate issued successfully"
              exit 0
            fi
            if docker logs bootroot-agent 2>&1 | grep -q "Certificate issuance succeeded"; then
              echo "PASS: Certificate issued successfully"
              exit 0
            fi
            echo "Waiting for certificate issuance..."
            sleep 5
          done

          echo "FAIL: Certificate issue message not found"
          echo "=== Agent Logs ==="
          docker logs bootroot-agent
          exit 1

      - name: Cleanup
        if: always()
        run: docker compose down
