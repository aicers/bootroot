# Configuration

bootroot-agent reads a TOML configuration file (default `agent.toml`).
The full template lives in `agent.toml.example`.

## bootroot CLI

CLI usage is documented in the [CLI manual](cli.md). This document focuses on
the **manual configuration** flow.

## OpenBao Agent

OpenBao Agent reads secrets from OpenBao and renders them to files.
`agent.hcl` is the **OpenBao Agent configuration file**. It defines
template/output paths and AppRole login details. It is not a secret file
itself; OpenBao Agent uses it to render the actual secret files.
`bootroot init` generates step-ca/responder agent configs at
`secrets/openbao/stepca/agent.hcl` and `secrets/openbao/responder/agent.hcl`.
`bootroot service add` prints the per-service OpenBao Agent config path, which
defaults to `secrets/openbao/services/<service>/agent.hcl`.

OpenBao Agent logs in via AppRole using `role_id`/`secret_id` stored under
`secrets/services/<service>/`. Keep the directory `0700` and the files `0600`.

Ownership is split as follows:

- **step-ca/responder**: `bootroot init` generates `agent.hcl` automatically.
- **services added with `--delivery-mode local-file`**:
  `bootroot service add` auto-applies per-service
  OpenBao Agent config/template and managed `agent.toml` profile.
- **services added with `--delivery-mode remote-bootstrap`**:
  `bootroot service add` generates a bootstrap
  artifact, and `bootroot-remote sync` applies `agent.hcl`/template/token and
  managed `agent.toml` profile on the remote host.

Sample `agent.hcl` snippet:

```hcl
exit_after_auth = false
pid_file = "/openbao/secrets/openbao/services/edge-proxy/agent.pid"

auto_auth {
  method "approle" {
    mount_path = "auth/approle"
    config = {
      role_id_file_path = "/openbao/secrets/services/edge-proxy/role_id"
      secret_id_file_path = "/openbao/secrets/services/edge-proxy/secret_id"
    }
  }
  sink "file" {
    config = {
      path = "/openbao/secrets/openbao/services/edge-proxy/token"
    }
  }
}

template {
  source = "/openbao/secrets/openbao/services/edge-proxy/agent.toml.ctmpl"
  destination = "/openbao/secrets/services/edge-proxy/agent.toml"
}
```

This snippet is for **manual setup reference**. In the bootroot CLI
workflow, the simplest path is to use the `agent.hcl` generated by
`bootroot init`/`bootroot service add`.

For services added with `--delivery-mode remote-bootstrap`,
`bootroot-remote sync` can generate a baseline
`agent.toml` when the file does not exist yet. Baseline generation is driven by
these inputs:

- `--agent-email`
- `--agent-server`
- `--agent-domain`
- `--agent-responder-url`
- `--profile-hostname`
- `--profile-instance-id`
- `--profile-cert-path`
- `--profile-key-path`

What each field means:

- `exit_after_auth`: `true` exits after auth; `false` keeps the agent running.
- `pid_file`: path to the agent PID file.
- `auto_auth.method`: AppRole login config that reads `role_id`/`secret_id`.
- `auto_auth.sink`: file path where the issued token is written.
- `template`: renders config/secret files from OpenBao KV data.

## bootroot-agent (agent.toml)

### Global Settings

```toml
email = "admin@example.com"
server = "https://localhost:9000/acme/acme/directory"
domain = "trusted.domain"
```

- `email`: ACME account contact email. The account is created automatically
  on first contact with step-ca, and step-ca stores this address. step-ca
  does not send mail by default, but operators can wire alerts to this
  address, so use a real inbox in production. In this context, “step-ca
  account” and “ACME account” mean the same registration.
- `server`: ACME directory URL used as the entry point for step-ca.
  - Only `https://` URLs are supported. `http://` is refused at runtime.
  - `localhost` only works when step-ca runs on the same host as
    bootroot-agent. Otherwise use the step-ca host/IP.
  - The path is `/acme/<provisioner-name>/directory`. In our dev config the
    provisioner name is `acme`, so the path becomes `/acme/acme/directory`.
    If you rename the provisioner in `secrets/config/ca.json`, this path
    changes accordingly.
  Examples:
    - Docker Compose: `https://bootroot-ca:9000/acme/acme/directory`
    - Host install (same host): `https://localhost:9000/acme/acme/directory`
    - Remote step-ca: `https://<step-ca-host>:9000/acme/<provisioner>/directory`
- `domain`: root domain used to auto-generate the DNS SAN as
  `instance_id.service_name.hostname.domain` (daemon and docker).

### Scheduler

```toml
[scheduler]
max_concurrent_issuances = 3
```

Limits concurrent issuance operations across profiles.
This caps how many issuance/renewal workflows run at the same time; extra
requests wait in a queue. Use it to avoid overloading step-ca or the host.

### ACME

```toml
[acme]
directory_fetch_attempts = 10
directory_fetch_base_delay_secs = 1
directory_fetch_max_delay_secs = 10
poll_attempts = 15
poll_interval_secs = 2
http_responder_url = "http://localhost:8080"
http_responder_hmac = "change-me"
http_responder_timeout_secs = 5
http_responder_token_ttl_secs = 300
```

Controls HTTP-01 responder settings and retry behavior for ACME operations.

- `http_responder_url`: base URL of the HTTP-01 responder **admin API**.
  bootroot-agent calls this endpoint to register tokens.
  Examples:
  - Docker Compose: `http://bootroot-http01:8080`
  - Remote responder: `http://<responder-host>:8080`
- `http_responder_hmac`: shared HMAC secret for registering tokens. This must
  match the responder's `hmac_secret`.
- `http_responder_timeout_secs`: request timeout to the responder
- `http_responder_token_ttl_secs`: token TTL in seconds

### Trust

```toml
[trust]
verify_certificates = true
ca_bundle_path = "/etc/bootroot/ca-bundle.pem"
trusted_ca_sha256 = ["<sha256-hex>"]
```

Controls mTLS trust and **ACME server TLS verification**.

Concepts:

- **mTLS trust**: the trust bundle used by services to verify peer
  certificates. bootroot-agent writes the chain (intermediate/root) to
  `ca_bundle_path`, and services use that file as their trust store.
- **ACME server TLS verification**: bootroot-agent verifies the step-ca
  server certificate when communicating with the ACME endpoint. This is
  separate from mTLS trust.

Settings:

- `verify_certificates`: enables **ACME server TLS verification**.
  This is not an mTLS setting; it only affects how bootroot-agent validates
  the step-ca server certificate.
- `ca_bundle_path`: path where bootroot-agent writes the CA bundle
  (intermediate/root only). When `verify_certificates = true`, setting this
  also makes bootroot-agent trust **this bundle** for the ACME server.
- `trusted_ca_sha256`: list of trusted CA cert fingerprints (SHA-256 hex).

`trusted_ca_sha256` must match **real CA certificate fingerprints** (not
arbitrary values). `bootroot init` stores CA fingerprints in OpenBao, and
`bootroot service add` applies them differently by `--delivery-mode`:

- `--delivery-mode remote-bootstrap`: fingerprints are automatically written
  to the
  per-service remote sync trust path and then applied to `agent.toml` on the
  service machine by `bootroot-remote sync`.
- `--delivery-mode local-file`: trust fields are not auto-inserted into
  `agent.toml`, so set
  them manually when needed.

If `verify_certificates = true` and `ca_bundle_path` is **not** set,
bootroot-agent uses the **system CA store** to validate the ACME server.

Default: `verify_certificates = false` for backward compatibility. For
production, enable verification and provide a trusted CA source.

Operational notes:

- On the **first** connection to step-ca, a trusted bundle must already exist
  at `ca_bundle_path` (manual install). If that is inconvenient, you can
  **temporarily** use `bootroot-agent --insecure` to obtain the first cert.
- After issuance succeeds, bootroot-agent writes the chain to `ca_bundle_path`.
  For **renewals** (cron/daemon), do **not** use `--insecure`; keep
  verification enabled.
- This workflow lets you keep `verify_certificates = true` in `agent.toml` and
  use CLI flags only as a temporary bypass.

Note: in a single step-ca deployment, it is practical to reuse the same
`ca_bundle_path` for both mTLS trust and ACME server verification. The two
concepts are still different, so keep them distinct in your mental model.

If trust is missing or empty in services using
`--delivery-mode remote-bootstrap`, check:

- `secrets/certs/root_ca.crt` and `secrets/certs/intermediate_ca.crt` exist
- `bootroot init` ran with the same `secrets_dir`
- `secret/bootroot/ca` in OpenBao contains `trusted_ca_sha256`

Permissions note: the service consuming the CA bundle must be able to read
`ca_bundle_path`. The simplest setup is to run bootroot-agent and the service
as the same user or group; otherwise ensure the file and parent directory
permissions allow read access.

### Retry Settings

```toml
[retry]
backoff_secs = [5, 10, 30]
```

Used when issuance or renewal fails. Profiles can override this.

### EAB (Optional)

```toml
[eab]
kid = "your-key-id"
hmac = "your-hmac-key"
```

EAB can also be passed via CLI (`--eab-kid`, `--eab-hmac`, or `--eab-file`).
For production, prefer injecting EAB values via OpenBao.

### Command-line options

`bootroot-agent` can only override a subset of settings.
Apply order is `agent.toml` → environment variables → CLI options, with CLI
being applied last.

Example: even if `agent.toml` has `email = "admin@example.com"`,
running `bootroot-agent --email ops@example.com` uses `ops@example.com`.

Options:

- `--config <PATH>`: config file path (default `agent.toml`)
- `--email <EMAIL>`: support email address
- `--ca-url <URL>`: ACME directory URL
- `--http-responder-url <URL>`: HTTP-01 responder URL
  (env `BOOTROOT_HTTP_RESPONDER_URL`)
- `--http-responder-hmac <HMAC>`: HTTP-01 responder HMAC
  (env `BOOTROOT_HTTP_RESPONDER_HMAC`)
- `--eab-kid <KID>`: EAB Key ID
- `--eab-hmac <HMAC>`: EAB HMAC key
- `--eab-file <PATH>`: EAB JSON file path
- `--oneshot`: issue once and exit (disable daemon loop)
- `--verify-certificates`: force ACME server TLS verification
- `--insecure`: disable ACME server TLS verification

All other settings (profiles, retry, scheduler, hooks, CA bundle paths, etc.)
must be defined in `agent.toml`.

### Profiles

Each profile represents one daemon instance (one certificate identity).

```toml
[[profiles]]
service_name = "edge-proxy"
instance_id = "001"
hostname = "edge-node-01"

[profiles.paths]
cert = "certs/edge-proxy-a.pem"
key = "certs/edge-proxy-a.key"

[profiles.daemon]
check_interval = "1h"
renew_before = "720h"
check_jitter = "0s"
```

The DNS SAN is auto-generated as
`<instance-id>.<service-name>.<hostname>.<domain>` (daemon and docker). This
name is also the target for HTTP-01 validation, so it must resolve from step-ca
to the HTTP-01 responder IP (for Compose, update the network alias; for host
installs, update `/etc/hosts` or DNS).

#### Profile Retry Override

```toml
[profiles.retry]
backoff_secs = [5, 10, 30]
```

#### Hooks

```toml
[profiles.hooks.post_renew]
# success = [
#   {
#     command = "nginx"
#     args = ["-s", "reload"]
#     working_dir = "/etc/nginx"
#     timeout_secs = 30
#     retry_backoff_secs = [5, 10, 30]
#     max_output_bytes = 4096
#     on_failure = "continue"
#   }
# ]
```

- `working_dir`: per-hook working directory
- `max_output_bytes`: truncate stdout/stderr (logs show truncation)
- `on_failure`: `continue` or `stop`

Hooks run **after** issuance/renewal completes. Use `success` for actions that
should run only when a certificate is issued/renewed, and `failure` for alerting
or cleanup when issuance fails.

What hooks are used for:

- Reload or restart a daemon so it reads the new certificate
- Send notifications (Slack, email, monitoring)
- Trigger deploy or sync scripts

How reloads work (important for daemon owners):

- `systemctl reload <service>` runs the unit’s `ExecReload` or sends a reload
  signal if configured.
- You can also send a signal directly, for example:
  `command = "kill"` and `args = ["-HUP", "<pid>"]`.
- The daemon must **support reload** (signal handling or config reload logic).
  If it does not, use a restart (`systemctl restart ...`) instead.

### CLI Overrides

```bash
bootroot-agent --config agent.toml --oneshot
bootroot-agent --config agent.toml --email admin@example.com
bootroot-agent --config agent.toml --eab-kid X --eab-hmac Y
```

CLI values override file settings when provided.
The precedence order is `agent.toml` → environment variables → CLI options,
so CLI has the highest priority. For example, if `agent.toml` sets
`email = "admin@example.com"`, running `bootroot-agent --email ops@example.com`
uses `ops@example.com`.

## HTTP-01 responder (responder.toml)

The responder reads `responder.toml` (or `BOOTROOT_RESPONDER__*` env vars).

```toml
listen_addr = "0.0.0.0:80"
admin_addr = "0.0.0.0:8080"
hmac_secret = "change-me"
token_ttl_secs = 300
cleanup_interval_secs = 30
max_skew_secs = 60
```

- `listen_addr`: address where step-ca sends **HTTP-01 validation requests**.
  The responder replies to `/.well-known/acme-challenge/<token>` with the key
  authorization.
- `admin_addr`: **admin API** where bootroot-agent registers tokens so the
  responder can answer on `listen_addr`.
- `hmac_secret`: shared secret (must match `acme.http_responder_hmac`)
- `token_ttl_secs`: how long tokens stay valid
- `cleanup_interval_secs`: how often expired tokens are removed
- `max_skew_secs`: allowed clock skew for admin requests
