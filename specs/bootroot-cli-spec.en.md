# Bootroot CLI Spec (Issue #57)

## Purpose

Define the interactive `bootroot` CLI that fully bootstraps OpenBao + step-ca
(PostgreSQL) + HTTP-01 responder on a single machine, and onboards new apps
(daemon or Next.js) with verification. This spec is implementation-facing and
i18n-ready (EN/KR).

## Non-Goals

- Multi-host orchestration
- Kubernetes support
- HSM/PKCS11 integration
- Full PKI lifecycle beyond issuance/renewal verification

## Assumptions

- OpenBao, PostgreSQL, step-ca, and the HTTP-01 responder run as Docker images
  on the same machine.
- The CLI can start containers and set restart policies, but may skip pulls when
  local images are available.
- The CLI can call the OpenBao HTTP API directly (Vault-compatible).
- The CLI can run local commands (docker/compose) when required.
- Secrets are rendered by OpenBao Agent to local files; apps read files.

## CLI UX Requirements

- Subcommand-based CLI with interactive prompts.
- Optional REPL mode (future) but not required for initial release.
- Explicit confirmation for destructive actions (re-init, overwrite, delete).
- Clear summary of actions, generated artifacts, and next steps.
- i18n: English + Korean at launch; string keys externalized for future
  languages.

## Commands

- `bootroot infra up`:
  - Pull/load images and start OpenBao/PostgreSQL/step-ca/responder.
- `bootroot init`:
  - Configure services after infrastructure is up.
- `bootroot status`:
  - Check readiness and current state.
- `bootroot app add`:
  - Onboard a new app (daemon or Next.js sidecar).
- `bootroot app info`:
  - Show onboarding instructions and current config for an app.
- `bootroot verify`:
  - Verify issuance by triggering a test cert flow and checking artifacts.

## State/Config Storage

- Default state directory: `./state/bootroot` (configurable).
- Files:
  - `state.json`: CLI state (OpenBao URL, mounts, AppRole names, known apps).
  - `templates/`: rendered template copies (for audit/debug).
- The CLI must never persist `root_token` or `unseal_keys` unless explicitly
  confirmed.

## OpenBao API Calls (Canonical)

- Init: `POST /v1/sys/init`
- Unseal: `POST /v1/sys/unseal`
- Health: `GET /v1/sys/health`
- Enable KV v2 (if needed): `POST /v1/sys/mounts/<mount>`
- Enable AppRole auth: `POST /v1/sys/auth/approle`
- Create policy: `PUT /v1/sys/policies/acl/<name>`
- Create AppRole: `POST /v1/auth/approle/role/<name>`
- Read role_id: `GET /v1/auth/approle/role/<name>/role-id`
- Create secret_id: `POST /v1/auth/approle/role/<name>/secret-id`
- Write secrets (KV v2): `POST /v1/<mount>/data/<path>`

## OpenBao KV v2 Note

KV v2 is the recommended key-value secrets engine. It provides secret
versioning, metadata, and soft-delete support, which are important for rotation
and recovery.

## Bootstrap Flow: `bootroot init`

### Step 0: Language

- Prompt: choose language (EN/KR) or use `--lang`.

### Step 1: Infrastructure readiness check

- Ensure OpenBao/PostgreSQL/step-ca/responder containers are running.
- If not running, fail with instructions to run `bootroot infra up` first.

### Step 2: OpenBao

- Prompt: OpenBao URL, token source (root token), KV mount path (default
  `secret`).
- If not initialized:
  - Run `sys/init`, capture unseal keys + root token.
  - Prompt user to confirm secure storage.
  - Unseal with required keys.
- Enable KV v2 (if missing), enable AppRole auth (if missing).

### Step 3: Policies + AppRole

- Create policies for:
  - bootroot-agent OpenBao Agent (reads secrets)
  - responder OpenBao Agent (reads HMAC only)
  - step-ca OpenBao Agent (reads password/DB only)
- Create AppRoles and capture `role_id`/`secret_id`.
- Prompt: display/save role_id/secret_id (manual handoff required).

### Step 4: Register Secrets

- Prompt for:
  - step-ca key password
  - DB password or DSN components
  - HTTP-01 HMAC
- Each item can be user-provided or auto-generated by the CLI (secure random).
- Once registered, OpenBao/Agent handles injection and rotation; users do not
  need to remember them.
- Store in OpenBao paths:
  - `secret/bootroot/stepca/password`
  - `secret/bootroot/stepca/db`
  - `secret/bootroot/responder/hmac`
- Note: EAB is registered after step-ca is initialized.

### Input precedence matrix

- OpenBao URL: `--openbao-url` → default (`http://localhost:8200`)
- KV mount: `--kv-mount` → default (`secret`)
- secrets dir: `--secrets-dir` → default (`secrets`)
- compose file: `--compose-file` → default (`docker-compose.yml`)
- root token: `--root-token` → `OPENBAO_ROOT_TOKEN` → prompt (when already
  initialized)
- unseal key: `--unseal-key` (repeatable) → `OPENBAO_UNSEAL_KEYS`
  (comma-separated) → keys generated during init
- step-ca password: `--stepca-password` → `STEPCA_PASSWORD` →
  `--auto-generate` → prompt
- DB DSN: `--db-dsn` → derived from `POSTGRES_*` → prompt
  - `POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_DB` (required)
  - `POSTGRES_HOST` (default `postgres`), `POSTGRES_PORT` (default `5432`)
- HTTP-01 HMAC: `--http-hmac` → `HTTP01_HMAC` → `--auto-generate` → prompt
- EAB: requires both `--eab-kid` and `--eab-hmac` (optional)
  - `EAB_KID`, `EAB_HMAC`

### Step 5: step-ca OpenBao Agent (pre-init)

- Render `password.txt` and `ca.json` using OpenBao Agent templates.
- Validate file permissions (0600/0700).

### Step 6: step-ca Initialization

- Run `step ca init` (Docker) using the rendered `password.txt`.
- Validate that `secrets/config/ca.json` exists and DB DSN matches.

### Step 7: EAB issuance + registration

- Prompt: issue EAB credentials from step-ca.
- Register `kid`/`hmac` into OpenBao at `secret/bootroot/stepca/eab`.

### Step 8: Responder + bootroot-agent OpenBao Agent

- Render responder config with HMAC.
- Render bootroot-agent config with EAB and responder HMAC.

### Step 9: Summary

- Show all generated artifacts, Docker services status, and next steps.
- Next steps guidance:
  - Deploy OpenBao Agent templates for step-ca and responder
  - Restart or reload step-ca and responder
  - Run `bootroot status` to verify services
  - (Optional) Store EAB kid/hmac at `secret/bootroot/agent/eab`

## App Onboarding: `bootroot app add`

### Binary daemon (host-based)

- Prompt: service name, instance_id, hostname, domain, cert/key paths.
- Update bootroot-agent config `profiles[]` (per-daemon cert, no sharing).
- Provide instructions to reload bootroot-agent.

### Next.js Docker app (sidecar)

- Prompt: app name, container name, domain, cert/key mount paths.
- Create AppRole for the app's OpenBao Agent (policy-limited).
- Output sidecar snippets (bootroot-agent + OpenBao Agent) and volume mounts.

### Verification

- Option to run `bootroot verify --app <name>` immediately.

## Read-only Info: `bootroot app info`

- Show:
  - App type, config paths
  - AppRole name and policy
  - OpenBao secret paths used
  - Expected cert/key output paths

## Verification: `bootroot verify`

- For a target app/profile, run a one-shot issuance and check:
  - bootroot-agent logs include success
  - cert/key files exist and are readable
- Output a pass/fail report.

## i18n

- Strings stored in `i18n/en.json` and `i18n/ko.json` (or similar).
- Keys are stable, e.g. `prompt.openbao_url`, `error.unseal_failed`.
- Default language: English; `--lang` overrides.

## Error Handling

- Clear actionable errors with next-step hints.
- Fail fast if OpenBao or step-ca are unreachable.

## Security Notes

- Never log secrets.
- Never persist root token/unseal keys unless explicitly confirmed.
- Ensure key files are 0600 and secret dirs 0700.
